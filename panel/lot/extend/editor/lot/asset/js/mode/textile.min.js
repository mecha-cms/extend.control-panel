!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function r(e,t){t.mode=d.newLayout,t.tableHeading=!1,"definitionList"===t.layoutType&&t.spanningLayout&&e.match(f("definitionListEnd"),!1)&&(t.spanningLayout=!1)}function i(e,r,i){if("_"===i)return e.eat("_")?n(e,r,"italic",/__/,2):n(e,r,"em",/_/,1);if("*"===i)return e.eat("*")?n(e,r,"bold",/\*\*/,2):n(e,r,"strong",/\*/,1);if("["===i)return e.match(/\d+\]/)&&(r.footCite=!0),a(r);if("("===i){var o=e.match(/^(r|tm|c)\)/);if(o)return l(r,t.specialChar)}if("<"===i&&e.match(/(\w+)[^>]+>[^<]+<\/\1>/))return l(r,t.html);if("?"===i&&e.eat("?"))return n(e,r,"cite",/\?\?/,2);if("="===i&&e.eat("="))return n(e,r,"notextile",/==/,2);if("-"===i&&!e.eat("-"))return n(e,r,"deletion",/-/,1);if("+"===i)return n(e,r,"addition",/\+/,1);if("~"===i)return n(e,r,"sub",/~/,1);if("^"===i)return n(e,r,"sup",/\^/,1);if("%"===i)return n(e,r,"span",/%/,1);if("@"===i)return n(e,r,"code",/@/,1);if("!"===i){var s=n(e,r,"image",/(?:\([^\)]+\))?!/,1);return e.match(/^:\S+/),s}return a(r)}function n(e,t,r,i,n){var o=e.pos>n?e.string.charAt(e.pos-n-1):null,l=e.peek();if(t[r]){if((!l||/\W/.test(l))&&o&&/\S/.test(o)){var s=a(t);return t[r]=!1,s}}else(!o||/\W/.test(o))&&l&&/\S/.test(l)&&e.match(new RegExp("^.*\\S"+i.source+"(?:\\W|$)"),!1)&&(t[r]=!0,t.mode=d.attributes);return a(t)}function a(e){var r=o(e);if(r)return r;var i=[];return e.layoutType&&i.push(t[e.layoutType]),i=i.concat(s(e,"addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","strong","sub","sup","table","tableHeading")),"header"===e.layoutType&&i.push(t.header+"-"+e.header),i.length?i.join(" "):null}function o(e){var r=e.layoutType;switch(r){case"notextile":case"code":case"pre":return t[r];default:return e.notextile?t.notextile+(r?" "+t[r]:""):null}}function l(e,t){var r=o(e);if(r)return r;var i=a(e);return t?i?i+" "+t:t:i}function s(e){for(var r=[],i=1;i<arguments.length;++i)e[arguments[i]]&&r.push(t[arguments[i]]);return r}function u(e){var t=e.spanningLayout,r=e.layoutType;for(var i in e)e.hasOwnProperty(i)&&delete e[i];e.mode=d.newLayout,t&&(e.layoutType=r,e.spanningLayout=!0)}function f(e){return c.cache[e]||(c.cache[e]=c.createRe(e))}var t={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"},c={cache:{},single:{bc:"bc",bq:"bq",definitionList:/- .*?:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},attributes:{align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/},createRe:function(e){switch(e){case"drawTable":return c.makeRe("^",c.single.drawTable,"$");case"html":return c.makeRe("^",c.single.html,"(?:",c.single.html,")*","$");case"linkDefinition":return c.makeRe("^",c.single.linkDefinition,"$");case"listLayout":return c.makeRe("^",c.single.list,f("allAttributes"),"*\\s+");case"tableCellAttributes":return c.makeRe("^",c.choiceRe(c.single.tableCellAttributes,f("allAttributes")),"+\\.");case"type":return c.makeRe("^",f("allTypes"));case"typeLayout":return c.makeRe("^",f("allTypes"),f("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return c.makeRe("^",f("allAttributes"),"+");case"allTypes":return c.choiceRe(c.single.div,c.single.foot,c.single.header,c.single.bc,c.single.bq,c.single.notextile,c.single.pre,c.single.table,c.single.para);case"allAttributes":return c.choiceRe(c.attributes.selector,c.attributes.css,c.attributes.lang,c.attributes.align,c.attributes.pad);default:return c.makeRe("^",c.single[e])}},makeRe:function(){for(var e="",t=0;t<arguments.length;++t){var r=arguments[t];e+="string"==typeof r?r:r.source}return new RegExp(e)},choiceRe:function(){for(var e=[arguments[0]],t=1;t<arguments.length;++t)e[2*t-1]="|",e[2*t]=arguments[t];return e.unshift("(?:"),e.push(")"),c.makeRe.apply(null,e)}},d={newLayout:function(e,t){if(e.match(f("typeLayout"),!1))return t.spanningLayout=!1,(t.mode=d.blockType)(e,t);var r;return o(t)||(e.match(f("listLayout"),!1)?r=d.list:e.match(f("drawTable"),!1)?r=d.table:e.match(f("linkDefinition"),!1)?r=d.linkDefinition:e.match(f("definitionList"))?r=d.definitionList:e.match(f("html"),!1)&&(r=d.html)),(t.mode=r||d.text)(e,t)},blockType:function(e,t){var r,i;return t.layoutType=null,(r=e.match(f("type")))?(i=r[0],(r=i.match(f("header")))?(t.layoutType="header",t.header=parseInt(r[0][1])):i.match(f("bq"))?t.layoutType="quote":i.match(f("bc"))?t.layoutType="code":i.match(f("foot"))?t.layoutType="footnote":i.match(f("notextile"))?t.layoutType="notextile":i.match(f("pre"))?t.layoutType="pre":i.match(f("div"))?t.layoutType="div":i.match(f("table"))&&(t.layoutType="table"),t.mode=d.attributes,a(t)):(t.mode=d.text)(e,t)},text:function(e,t){if(e.match(f("text")))return a(t);var r=e.next();return'"'===r?(t.mode=d.link)(e,t):i(e,t,r)},attributes:function(e,r){return r.mode=d.layoutLength,e.match(f("attributes"))?l(r,t.attributes):a(r)},layoutLength:function(e,t){return e.eat(".")&&e.eat(".")&&(t.spanningLayout=!0),t.mode=d.text,a(t)},list:function(e,t){var r=e.match(f("list"));t.listDepth=r[0].length;var i=(t.listDepth-1)%3;return i?1===i?t.layoutType="list2":t.layoutType="list3":t.layoutType="list1",t.mode=d.attributes,a(t)},link:function(e,r){return r.mode=d.text,e.match(f("link"))?(e.match(/\S+/),l(r,t.link)):a(r)},linkDefinition:function(e,r){return e.skipToEnd(),l(r,t.linkDefinition)},definitionList:function(e,t){return e.match(f("definitionList")),t.layoutType="definitionList",e.match(/\s*$/)?t.spanningLayout=!0:t.mode=d.attributes,a(t)},html:function(e,r){return e.skipToEnd(),l(r,t.html)},table:function(e,t){return t.layoutType="table",(t.mode=d.tableCell)(e,t)},tableCell:function(e,t){return e.match(f("tableHeading"))?t.tableHeading=!0:e.eat("|"),t.mode=d.tableCellAttributes,a(t)},tableCellAttributes:function(e,r){return r.mode=d.tableText,e.match(f("tableCellAttributes"))?l(r,t.attributes):a(r)},tableText:function(e,t){return e.match(f("tableText"))?a(t):"|"===e.peek()?(t.mode=d.tableCell,a(t)):i(e,t,e.next())}};e.defineMode("textile",function(){return{startState:function(){return{mode:d.newLayout}},token:function(e,t){return e.sol()&&r(e,t),t.mode(e,t)},blankLine:u}}),e.defineMIME("text/x-textile","textile")});