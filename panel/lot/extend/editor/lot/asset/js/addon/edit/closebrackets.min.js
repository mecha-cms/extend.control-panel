!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){function i(e,r){return"pairs"==r&&"string"==typeof e?e:"object"==typeof e&&null!=e[r]?e[r]:t[r]}function l(e){return function(t){return d(t,e)}}function s(e){var t=e.state.closeBrackets;if(!t||t.override)return t;var r=e.getModeAt(e.getCursor());return r.closeBrackets||t}function u(t){var n=s(t);if(!n||t.getOption("disableInput"))return e.Pass;for(var a=i(n,"pairs"),o=t.listSelections(),l=0;l<o.length;l++){if(!o[l].empty())return e.Pass;var u=m(t,o[l].head);if(!u||a.indexOf(u)%2!=0)return e.Pass}for(var l=o.length-1;l>=0;l--){var c=o[l].head;t.replaceRange("",r(c.line,c.ch-1),r(c.line,c.ch+1),"+delete")}}function c(t){var r=s(t),n=r&&i(r,"explode");if(!n||t.getOption("disableInput"))return e.Pass;for(var a=t.listSelections(),o=0;o<a.length;o++){if(!a[o].empty())return e.Pass;var l=m(t,a[o].head);if(!l||n.indexOf(l)%2!=0)return e.Pass}t.operation(function(){t.replaceSelection("\n\n",null),t.execCommand("goCharLeft"),a=t.listSelections();for(var e=0;e<a.length;e++){var r=a[e].head.line;t.indentLine(r,null,!0),t.indentLine(r+1,null,!0)}})}function f(t){var i=e.cmpPos(t.anchor,t.head)>0;return{anchor:new r(t.anchor.line,t.anchor.ch+(i?-1:1)),head:new r(t.head.line,t.head.ch+(i?1:-1))}}function d(t,n){var a=s(t);if(!a||t.getOption("disableInput"))return e.Pass;var o=i(a,"pairs"),l=o.indexOf(n);if(-1==l)return e.Pass;for(var v,u=i(a,"triples"),c=o.charAt(l+1)==n,d=t.listSelections(),m=l%2==0,y=0;y<d.length;y++){var _,b=d[y],x=b.head,w=t.getRange(x,r(x.line,x.ch+1));if(m&&!b.empty())_="surround";else if(!c&&m||w!=n)if(c&&x.ch>1&&u.indexOf(n)>=0&&t.getRange(r(x.line,x.ch-2),x)==n+n&&(x.ch<=2||t.getRange(r(x.line,x.ch-3),r(x.line,x.ch-2))!=n))_="addFour";else if(c){if(e.isWordChar(w)||!h(t,x,n))return e.Pass;_="both"}else{if(!m||t.getLine(x.line).length!=x.ch&&!p(w,o)&&!/\s/.test(w))return e.Pass;_="both"}else _=c&&g(t,x)?"both":u.indexOf(n)>=0&&t.getRange(x,r(x.line,x.ch+3))==n+n+n?"skipThree":"skip";if(v){if(v!=_)return e.Pass}else v=_}var k=l%2?o.charAt(l-1):n,C=l%2?n:o.charAt(l+1);t.operation(function(){if("skip"==v)t.execCommand("goCharRight");else if("skipThree"==v)for(var e=0;3>e;e++)t.execCommand("goCharRight");else if("surround"==v){for(var r=t.getSelections(),e=0;e<r.length;e++)r[e]=k+r[e]+C;t.replaceSelections(r,"around"),r=t.listSelections().slice();for(var e=0;e<r.length;e++)r[e]=f(r[e]);t.setSelections(r)}else"both"==v?(t.replaceSelection(k+C,null),t.triggerElectric(k+C),t.execCommand("goCharLeft")):"addFour"==v&&(t.replaceSelection(k+k+k+k,"before"),t.execCommand("goCharRight"))})}function p(e,t){var r=t.lastIndexOf(e);return r>-1&&r%2==1}function m(e,t){var i=e.getRange(r(t.line,t.ch-1),r(t.line,t.ch+1));return 2==i.length?i:null}function h(t,r,i){var n=t.getLine(r.line),a=t.getTokenAt(r);if(/\bstring2?\b/.test(a.type)||g(t,r))return!1;var o=new e.StringStream(n.slice(0,r.ch)+i+n.slice(r.ch),4);for(o.pos=o.start=a.start;;){var l=t.getMode().token(o,a.state);if(o.pos>=r.ch+1)return/\bstring2?\b/.test(l);o.start=o.pos}}function g(e,t){var i=e.getTokenAt(r(t.line,t.ch+1));return/\bstring/.test(i.type)&&i.start==t.ch}var t={pairs:"()[]{}''\"\"",triples:"",explode:"[]{}"},r=e.Pos;e.defineOption("autoCloseBrackets",!1,function(t,r,i){i&&i!=e.Init&&(t.removeKeyMap(a),t.state.closeBrackets=null),r&&(t.state.closeBrackets=r,t.addKeyMap(a))});for(var n=t.pairs+"`",a={Backspace:u,Enter:c},o=0;o<n.length;o++)a["'"+n.charAt(o)+"'"]=l(n.charAt(o))});