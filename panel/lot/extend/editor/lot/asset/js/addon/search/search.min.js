!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(t){e.lastIndex=t.pos;var r=e.exec(t.string);return r&&r.index==t.pos?(t.pos+=r[0].length||1,"searching"):void(r?t.pos=r.index:t.skipToEnd())}}}function r(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function i(e){return e.state.search||(e.state.search=new r)}function n(e){return"string"==typeof e&&e==e.toLowerCase()}function o(e,t,r){return e.getSearchCursor(t,r,{caseFold:n(t),multiline:!0})}function a(e,t,r,i,n){e.openDialog(t,i,{value:r,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){h(e)},onKeyDown:n})}function l(e,t,r,i,n){e.openDialog?e.openDialog(t,n,{value:i,selectValueOnOpen:!0}):n(prompt(r,i))}function s(e,t,r,i){e.openConfirm?e.openConfirm(t,i):confirm(r)&&i[0]()}function c(e){return e.replace(/\\(.)/g,function(e,t){return"n"==t?"\n":"r"==t?"\r":t})}function u(e){var t=e.match(/^\/(.*)\/([a-z]*)$/);if(t)try{e=new RegExp(t[1],-1==t[2].indexOf("i")?"":"i")}catch(r){}else e=c(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function d(e,r,i){r.queryText=i,r.query=u(i),e.removeOverlay(r.overlay,n(r.query)),r.overlay=t(r.query,n(r.query)),e.addOverlay(r.overlay),e.showMatchesOnScrollbar&&(r.annotate&&(r.annotate.clear(),r.annotate=null),r.annotate=e.showMatchesOnScrollbar(r.query,n(r.query)))}function p(t,r,n,o){var s=i(t);if(s.query)return m(t,r);var c=t.getSelection()||s.lastQuery;if(n&&t.openDialog){var u=null,p=function(r,i){e.e_stop(i),r&&(r!=s.queryText&&(d(t,s,r),s.posFrom=s.posTo=t.getCursor()),u&&(u.style.opacity=1),m(t,i.shiftKey,function(e,r){var i;r.line<3&&document.querySelector&&(i=t.display.wrapper.querySelector(".CodeMirror-dialog"))&&i.getBoundingClientRect().bottom-4>t.cursorCoords(r,"window").top&&((u=i).style.opacity=.4)}))};a(t,f,c,p,function(r,n){var o=e.keyName(r),a=e.keyMap[t.getOption("keyMap")][o];a||(a=t.getOption("extraKeys")[o]),"findNext"==a||"findPrev"==a||"findPersistentNext"==a||"findPersistentPrev"==a?(e.e_stop(r),d(t,i(t),n),t.execCommand(a)):("find"==a||"findPersistent"==a)&&(e.e_stop(r),p(n,r))}),o&&c&&(d(t,s,c),m(t,r))}else l(t,f,"Search for:",c,function(e){e&&!s.query&&t.operation(function(){d(t,s,e),s.posFrom=s.posTo=t.getCursor(),m(t,r)})})}function m(t,r,n){t.operation(function(){var a=i(t),l=o(t,a.query,r?a.posFrom:a.posTo);(l.find(r)||(l=o(t,a.query,r?e.Pos(t.lastLine()):e.Pos(t.firstLine(),0)),l.find(r)))&&(t.setSelection(l.from(),l.to()),t.scrollIntoView({from:l.from(),to:l.to()},20),a.posFrom=l.from(),a.posTo=l.to(),n&&n(l.from(),l.to()))})}function h(e){e.operation(function(){var t=i(e);t.lastQuery=t.query,t.query&&(t.query=t.queryText=null,e.removeOverlay(t.overlay),t.annotate&&(t.annotate.clear(),t.annotate=null))})}function b(e,t,r){e.operation(function(){for(var i=o(e,t);i.findNext();)if("string"!=typeof t){var n=e.getRange(i.from(),i.to()).match(t);i.replace(r.replace(/\$(\d)/g,function(e,t){return n[t]}))}else i.replace(r)})}function x(e,t){if(!e.getOption("readOnly")){var r=e.getSelection()||i(e).lastQuery,n='<span class="CodeMirror-search-label">'+(t?"Replace all:":"Replace:")+"</span>";l(e,n+g,n,r,function(r){r&&(r=u(r),l(e,v,"Replace with:","",function(i){if(i=c(i),t)b(e,r,i);else{h(e);var n=o(e,r,e.getCursor("from")),a=function(){var c,t=n.from();!(c=n.findNext())&&(n=o(e,r),!(c=n.findNext())||t&&n.from().line==t.line&&n.from().ch==t.ch)||(e.setSelection(n.from(),n.to()),e.scrollIntoView({from:n.from(),to:n.to()}),s(e,y,"Replace?",[function(){l(c)},a,function(){b(e,r,i)}]))},l=function(e){n.replace("string"==typeof r?i:i.replace(/\$(\d)/g,function(t,r){return e[r]})),a()};a()}}))})}}var f='<span class="CodeMirror-search-label">Search:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',g=' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',v='<span class="CodeMirror-search-label">With:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',y='<span class="CodeMirror-search-label">Replace?</span> <button>Yes</button> <button>No</button> <button>All</button> <button>Stop</button>';e.commands.find=function(e){h(e),p(e)},e.commands.findPersistent=function(e){h(e),p(e,!1,!0)},e.commands.findPersistentNext=function(e){p(e,!1,!0,!0)},e.commands.findPersistentPrev=function(e){p(e,!0,!0,!0)},e.commands.findNext=p,e.commands.findPrev=function(e){p(e,!0)},e.commands.clearSearch=h,e.commands.replace=x,e.commands.replaceAll=function(e){x(e,!0)}});